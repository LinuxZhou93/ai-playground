<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¾ç¨‹è¯¦æƒ… | Tech Odyssey</title>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=Space+Grotesk:wght@400;700&display=swap"
        rel="stylesheet">

    <!-- Dependencies -->
    <script src="libs/tailwindcss.js"></script>
    <script src="libs/vue.global.prod.js"></script>
    <script src="libs/hls.min.js"></script>
    <script src="libs/marked.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        odyssey: {
                            purple: '#8B5CF6',
                            cyan: '#06B6D4',
                            pink: '#EC4899',
                            amber: '#F59E0B'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: white;
        }

        .glass {
            background: rgba(15, 15, 25, 0.7);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(139, 92, 246, 0.6), rgba(6, 182, 212, 0.6));
            border-radius: 4px;
        }

        .lesson-item {
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .lesson-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(2px);
        }

        .lesson-item.active {
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.2), rgba(6, 182, 212, 0.1));
            border-color: rgba(139, 92, 246, 0.3);
        }

        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body class="bg-black text-white">
    <div id="app" class="h-screen flex flex-col" v-cloak>
        <!-- Navigation -->
        <nav class="h-16 glass border-b border-indigo-500/20 flex-shrink-0">
            <div class="max-w-7xl mx-auto h-full px-6 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 rounded bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center font-bold">
                        T</div>
                    <span class="font-bold text-xl">Tech <span class="text-indigo-400">Odyssey</span></span>
                </div>
                <div class="flex items-center gap-4">
                    <a href="wiki.html"
                        class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-indigo-500/20 border border-indigo-500/30 text-indigo-300 hover:bg-indigo-500/40 hover:text-white transition-all text-xs font-bold group">
                        <span class="group-hover:animate-spin">ğŸŒŒ</span>
                        <span class="hidden sm:inline">çŸ¥è¯†æ˜Ÿç³»</span>
                    </a>
                    <a href="learn.html" class="text-sm text-slate-400 hover:text-white transition-colors">â† è¿”å›è¯¾ç¨‹åˆ—è¡¨</a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Sidebar: Lesson List -->
            <aside class="w-80 glass border-r border-white/10 overflow-y-auto">
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-2">{{ course.title }}</h2>
                    <p class="text-sm text-gray-400 mb-6">{{ course.description }}</p>

                    <!-- Progress -->
                    <div class="mb-6">
                        <div class="flex justify-between text-sm mb-2">
                            <span>å­¦ä¹ è¿›åº¦</span>
                            <span>{{ completedLessons }}/{{ totalLessons }}</span>
                        </div>
                        <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-odyssey-purple to-odyssey-cyan transition-all duration-500"
                                :style="{ width: progressPercentage + '%' }"></div>
                        </div>
                    </div>

                    <!-- Lesson List -->
                    <div class="space-y-2">
                        <div v-for="(lesson, index) in lessons" :key="lesson.id" @click="selectLesson(lesson)"
                            class="lesson-item p-4 rounded-xl cursor-pointer"
                            :class="{ 'active': currentLesson?.id === lesson.id }">
                            <div class="flex items-start gap-3">
                                <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0"
                                    :class="lesson.completed ? 'bg-green-500' : 'bg-gray-700'">
                                    {{ lesson.completed ? 'âœ“' : index + 1 }}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-semibold text-sm mb-1">{{ lesson.title }}</h4>
                                    <div class="flex items-center gap-2 text-xs text-gray-500">
                                        <span>{{ getLessonTypeLabel(lesson.type) }}</span>
                                        <span v-if="lesson.duration_seconds">â€¢ {{
                                            formatDuration(lesson.duration_seconds) }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main: Content Area -->
            <main class="flex-1 overflow-y-auto bg-[#0a0a0a]">
                <div class="max-w-5xl mx-auto p-8">
                    <!-- Loading State -->
                    <div v-if="loading" class="flex justify-center py-20">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
                    </div>

                    <!-- Video Lesson -->
                    <div v-else-if="currentLesson?.type === 'video'" class="space-y-6">
                        <div class="aspect-video bg-black rounded-2xl overflow-hidden">
                            <video ref="videoPlayer" class="w-full h-full" controls @timeupdate="handleTimeUpdate"
                                @ended="handleVideoEnded">
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                            </video>
                        </div>

                        <div>
                            <h1 class="text-3xl font-bold mb-3">{{ currentLesson.title }}</h1>
                            <div class="flex items-center gap-4 text-sm text-gray-400 mb-6">
                                <span>ğŸ“º è§†é¢‘è¯¾ç¨‹</span>
                                <span>â±ï¸ {{ formatDuration(currentLesson.duration_seconds) }}</span>
                                <span v-if="currentLesson.completed" class="text-green-400">âœ“ å·²å®Œæˆ</span>
                            </div>

                            <div class="flex gap-4">
                                <button v-if="previousLesson" @click="selectLesson(previousLesson)"
                                    class="px-6 py-3 rounded-xl glass hover:bg-white/10 transition-colors">
                                    â† ä¸Šä¸€è¯¾
                                </button>
                                <button @click="markAsCompleted"
                                    class="px-6 py-3 rounded-xl bg-gradient-to-r from-odyssey-purple to-odyssey-pink text-white font-bold hover:scale-105 transition-transform"
                                    :disabled="currentLesson.completed">
                                    {{ currentLesson.completed ? 'âœ“ å·²å®Œæˆ' : 'æ ‡è®°ä¸ºå®Œæˆ' }}
                                </button>
                                <button v-if="nextLesson" @click="selectLesson(nextLesson)"
                                    class="px-6 py-3 rounded-xl bg-white text-black font-bold hover:scale-105 transition-transform">
                                    ä¸‹ä¸€è¯¾ â†’
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Reading Lesson -->
                    <div v-else-if="currentLesson?.type === 'reading'" class="glass rounded-2xl p-8">
                        <h1 class="text-3xl font-bold mb-6">{{ currentLesson.title }}</h1>
                        <div class="prose prose-invert max-w-none" v-html="renderMarkdown(currentLesson.content)"></div>
                        <div class="mt-8">
                            <button @click="markAsCompleted"
                                class="px-6 py-3 rounded-xl bg-gradient-to-r from-odyssey-purple to-odyssey-pink text-white font-bold">
                                æ ‡è®°ä¸ºå®Œæˆ
                            </button>
                        </div>
                    </div>

                    <!-- Quiz Lesson -->
                    <div v-else-if="currentLesson?.type === 'quiz'" class="max-w-3xl mx-auto">
                        <div v-if="!quizStarted" class="text-center py-12">
                            <h2 class="text-3xl font-bold mb-4">å‡†å¤‡å¥½æ¥å—æŒ‘æˆ˜äº†å—ï¼Ÿ</h2>
                            <p class="text-gray-400 mb-8">æœ¬æµ‹éªŒå°†æ£€æŸ¥æ‚¨å¯¹æœ¬èŠ‚è¯¾çŸ¥è¯†çš„æŒæ¡ç¨‹åº¦ã€‚</p>
                            <button @click="startQuiz"
                                class="px-8 py-3 bg-gradient-to-r from-odyssey-purple to-odyssey-pink rounded-full text-white font-bold">
                                å¼€å§‹æµ‹éªŒ
                            </button>
                        </div>

                        <div v-else-if="!quizCompleted" class="space-y-6">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-bold text-gray-500">é—®é¢˜ {{ currentQuestionIndex + 1 }} / {{
                                    quizQuestions.length }}</span>
                                <div class="w-32 h-2 bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-odyssey-purple transition-all"
                                        :style="{ width: ((currentQuestionIndex + 1) / quizQuestions.length * 100) + '%' }">
                                    </div>
                                </div>
                            </div>

                            <div class="glass rounded-2xl p-8">
                                <h3 class="text-xl font-bold mb-6">{{ quizQuestions[currentQuestionIndex].text }}</h3>
                                <div class="space-y-3">
                                    <div v-for="(option, idx) in quizQuestions[currentQuestionIndex].options" :key="idx"
                                        @click="selectOption(idx)"
                                        class="p-4 rounded-xl border transition-all cursor-pointer"
                                        :class="getOptionClass(idx)">
                                        {{ option }}
                                    </div>
                                </div>
                            </div>

                            <div v-if="hasAnsweredCurrent" class="flex justify-end">
                                <button @click="nextQuestion"
                                    class="px-6 py-2 bg-white text-black font-bold rounded-lg">
                                    {{ currentQuestionIndex < quizQuestions.length - 1 ? 'ä¸‹ä¸€é¢˜' : 'æŸ¥çœ‹ç»“æœ' }} </button>
                            </div>
                        </div>

                        <div v-else class="text-center py-12">
                            <div
                                class="w-24 h-24 rounded-full bg-gradient-to-tr from-green-400 to-emerald-600 flex items-center justify-center mx-auto mb-6">
                                <span class="text-4xl font-black">{{ quizScore }}</span>
                            </div>
                            <h2 class="text-3xl font-bold mb-2">æµ‹éªŒå®Œæˆ!</h2>
                            <p class="text-gray-400 mb-8">æ‚¨ç­”å¯¹äº† {{ correctAnswersCount }} / {{ quizQuestions.length }}
                                é“é¢˜ç›®</p>
                            <div class="flex justify-center gap-4">
                                <button @click="resetQuiz"
                                    class="px-6 py-2 border border-white/20 rounded-lg hover:bg-white/5">å†è¯•ä¸€æ¬¡</button>
                                <button @click="markAsCompleted"
                                    class="px-6 py-2 bg-white text-black font-bold rounded-lg">å®Œæˆè¯¾ç¨‹</button>
                            </div>
                        </div>
                    </div>

                    <!-- Code Lesson Placeholder -->
                    <div v-else-if="currentLesson?.type === 'code'" class="glass rounded-2xl p-8 text-center">
                        <h2 class="text-2xl font-bold mb-4">{{ currentLesson.title }}</h2>
                        <p class="text-gray-400 mb-6">ç¼–ç¨‹ç»ƒä¹ åŠŸèƒ½å³å°†æ¨å‡º...</p>
                        <button @click="markAsCompleted"
                            class="px-6 py-3 rounded-xl bg-gradient-to-r from-odyssey-purple to-odyssey-pink text-white font-bold">
                            æ ‡è®°ä¸ºå®Œæˆ
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick } = Vue;

        const app = createApp({
            setup() {
                // State
                const loading = ref(true);
                const course = ref({});
                const lessons = ref([]);
                const currentLesson = ref(null);
                const videoPlayer = ref(null);

                // Quiz State
                const quizStarted = ref(false);
                const quizCompleted = ref(false);
                const quizQuestions = ref([]);
                const currentQuestionIndex = ref(0);
                const selectedOptionIndex = ref(null);
                const hasAnsweredCurrent = ref(false);
                const quizScore = ref(0);
                const correctAnswersCount = ref(0);

                // Computed
                const totalLessons = computed(() => lessons.value.length);
                const completedLessons = computed(() => lessons.value.filter(l => l.completed).length);
                const progressPercentage = computed(() => {
                    if (totalLessons.value === 0) return 0;
                    return Math.round((completedLessons.value / totalLessons.value) * 100);
                });

                const previousLesson = computed(() => {
                    if (!currentLesson.value) return null;
                    const idx = lessons.value.findIndex(l => l.id === currentLesson.value.id);
                    return idx > 0 ? lessons.value[idx - 1] : null;
                });

                const nextLesson = computed(() => {
                    if (!currentLesson.value) return null;
                    const idx = lessons.value.findIndex(l => l.id === currentLesson.value.id);
                    return idx < lessons.value.length - 1 ? lessons.value[idx + 1] : null;
                });

                // Methods
                const loadMockData = async () => {
                    try {
                        const resp = await fetch('assets/data/course.json');
                        const data = await resp.json();

                        course.value = {
                            title: data.title,
                            description: data.description
                        };

                        lessons.value = (data.lessons || []).map(l => ({
                            ...l,
                            completed: l.completed || false,
                            type: l.type || 'reading',
                            content: l.type === 'quiz' && typeof l.content === 'object'
                                ? JSON.stringify(l.content)
                                : l.content
                        }));

                        if (lessons.value.length > 0) {
                            currentLesson.value = lessons.value[0];
                        }
                    } catch (e) {
                        console.error('Failed to load course data:', e);
                        course.value = { title: 'åŠ è½½å¤±è´¥', description: 'æ— æ³•åŠ è½½è¯¾ç¨‹æ•°æ®' };
                    } finally {
                        loading.value = false;
                    }
                };

                const selectLesson = (lesson) => {
                    currentLesson.value = lesson;

                    // Reset quiz state
                    quizStarted.value = false;
                    quizCompleted.value = false;
                    currentQuestionIndex.value = 0;
                    selectedOptionIndex.value = null;
                    hasAnsweredCurrent.value = false;
                    correctAnswersCount.value = 0;

                    // Initialize video player if needed
                    if (lesson.type === 'video' && lesson.content_url) {
                        nextTick(() => initVideoPlayer(lesson.content_url));
                    }
                };

                const initVideoPlayer = (url) => {
                    if (!videoPlayer.value) return;

                    if (Hls.isSupported()) {
                        const hls = new Hls();
                        hls.loadSource(url);
                        hls.attachMedia(videoPlayer.value);
                    } else if (videoPlayer.value.canPlayType('application/vnd.apple.mpegurl')) {
                        videoPlayer.value.src = url;
                    }
                };

                const markAsCompleted = () => {
                    if (!currentLesson.value) return;
                    currentLesson.value.completed = true;

                    // Auto-advance to next lesson
                    if (nextLesson.value) {
                        setTimeout(() => selectLesson(nextLesson.value), 1000);
                    }
                };

                const handleTimeUpdate = () => {
                    // Track video progress if needed
                };

                const handleVideoEnded = () => {
                    markAsCompleted();
                };

                const formatDuration = (seconds) => {
                    if (!seconds) return '0:00';
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                };

                const getLessonTypeLabel = (type) => {
                    const labels = {
                        'video': 'ğŸ“º è§†é¢‘',
                        'reading': 'ğŸ“– é˜…è¯»',
                        'quiz': 'ğŸ“ æµ‹éªŒ',
                        'code': 'ğŸ’» ç¼–ç¨‹'
                    };
                    return labels[type] || type;
                };

                const renderMarkdown = (text) => {
                    return marked.parse(text || '');
                };

                // Quiz Methods
                const startQuiz = () => {
                    if (currentLesson.value.type !== 'quiz') return;
                    try {
                        let content = currentLesson.value.content;
                        if (typeof content === 'string') content = JSON.parse(content);
                        if (content && content.questions) {
                            quizQuestions.value = content.questions;
                            quizStarted.value = true;
                        }
                    } catch (e) {
                        console.error('Failed to parse quiz content', e);
                    }
                };

                const selectOption = (index) => {
                    if (hasAnsweredCurrent.value) return;
                    selectedOptionIndex.value = index;
                    hasAnsweredCurrent.value = true;
                    if (index === quizQuestions.value[currentQuestionIndex.value].correctIndex) {
                        correctAnswersCount.value++;
                    }
                };

                const nextQuestion = () => {
                    if (currentQuestionIndex.value < quizQuestions.value.length - 1) {
                        currentQuestionIndex.value++;
                        selectedOptionIndex.value = null;
                        hasAnsweredCurrent.value = false;
                    } else {
                        quizScore.value = Math.round((correctAnswersCount.value / quizQuestions.value.length) * 100);
                        quizCompleted.value = true;
                    }
                };

                const resetQuiz = () => {
                    currentQuestionIndex.value = 0;
                    selectedOptionIndex.value = null;
                    hasAnsweredCurrent.value = false;
                    quizCompleted.value = false;
                    correctAnswersCount.value = 0;
                    quizStarted.value = false;
                };

                const getOptionClass = (index) => {
                    if (!hasAnsweredCurrent.value) {
                        return 'bg-white/5 border-white/10 hover:bg-white/10 cursor-pointer';
                    }
                    const correctIndex = quizQuestions.value[currentQuestionIndex.value].correctIndex;
                    if (index === correctIndex) {
                        return 'bg-green-500/20 border-green-500 text-green-300';
                    }
                    if (index === selectedOptionIndex.value && index !== correctIndex) {
                        return 'bg-red-500/20 border-red-500 text-red-300';
                    }
                    return 'bg-white/5 border-white/10 opacity-50';
                };

                // Lifecycle
                onMounted(async () => {
                    await loadMockData();
                });

                return {
                    loading,
                    course,
                    lessons,
                    currentLesson,
                    videoPlayer,
                    totalLessons,
                    completedLessons,
                    progressPercentage,
                    previousLesson,
                    nextLesson,
                    selectLesson,
                    markAsCompleted,
                    handleTimeUpdate,
                    handleVideoEnded,
                    formatDuration,
                    getLessonTypeLabel,
                    renderMarkdown,
                    quizStarted,
                    quizCompleted,
                    quizQuestions,
                    currentQuestionIndex,
                    selectedOptionIndex,
                    hasAnsweredCurrent,
                    quizScore,
                    correctAnswersCount,
                    startQuiz,
                    selectOption,
                    nextQuestion,
                    resetQuiz,
                    getOptionClass
                };
            }
        });

        app.mount('#app');
    </script>
</body>

</html>