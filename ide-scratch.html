<!DOCTYPE html>
<html lang="zh-CN" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scratch IDE | 在线编程</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        scratch: {
                            orange: '#FFAB19',
                            purple: '#855CD6',
                            cyan: '#4D97FF',
                            green: '#4CBF56'
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Outfit', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #scratch-container {
            width: 100%;
            height: calc(100vh - 64px);
        }

        #scratch-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-slate-900 text-white">
    <div class="flex h-screen bg-slate-900 text-white">
        <!-- Left Sidebar: Lessons -->
        <aside class="w-64 bg-slate-800 border-r border-slate-700 p-4 overflow-y-auto">
            <h2 class="text-lg font-bold mb-4" data-i18n="lessons">教学课程</h2>
            <ul class="space-y-2">
                <li v-for="lesson in lessons" :key="lesson.id" class="cursor-pointer p-2 rounded hover:bg-slate-700"
                    @click="loadLesson(lesson)">
                    {{ lesson.title }}
                </li>
            </ul>
            <button @click="resetEditor"
                class="mt-6 w-full px-3 py-2 bg-scratch-purple hover:bg-purple-600 rounded text-center font-semibold">
                重置编辑器
            </button>
        </aside>

        <!-- Main Area: Editor -->
        <main class="flex-1 flex flex-col">
            <!-- Top Bar (same as before) -->
            <nav
                class="h-16 border-b border-slate-700 bg-slate-900/95 backdrop-blur flex items-center justify-between px-6">
                <div class="flex items-center gap-4">
                    <a href="coding.html" class="p-2 rounded-lg hover:bg-slate-800 transition-colors">
                        <svg width="24" height="24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </a>
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-xl bg-gradient-to-br from-scratch-purple to-purple-600 flex items-center justify-center text-white font-black text-xl shadow-lg">
                            S</div>
                        <div>
                            <h1 class="font-bold text-white text-lg leading-tight" data-i18n="ide_title">Scratch IDE
                            </h1>
                            <div class="text-[10px] text-slate-500 uppercase tracking-widest font-bold"
                                data-i18n="ide_subtitle">在线编程环境</div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="toggleLanguage()"
                        class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-2"><svg
                            width="16" height="16" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
                        </svg><span id="lang-text">EN</span></button>
                    <button onclick="saveProject()"
                        class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-2"><svg
                            width="16" height="16" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h8a2 2 0 002-2V9a2 2 0 00-2-2h-1M8 7V5a2 2 0 012-2h2a2 2 0 012 2v2M8 7v5" />
                        </svg><span data-i18n="save">保存</span></button>
                    <button onclick="shareProject()"
                        class="px-4 py-2 bg-scratch-purple hover:bg-purple-600 rounded-lg text-sm font-bold transition-colors flex items-center gap-2"><svg
                            width="16" height="16" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm-1.316 6.632a3 3 0 11-5.367-2.684 3 3 0 015.367 2.684z" />
                        </svg><span data-i18n="share">分享</span></button>
                    <button onclick="toggleFullscreen()" class="p-2 rounded-lg hover:bg-slate-800 transition-colors"
                        title="全屏"><svg width="20" height="20" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                        </svg></button>
                </div>
            </nav>

            <!-- Editor Area -->
            <div id="scratch-container" class="flex-1 relative">
                <!-- Loading State -->
                <div id="loading" class="flex flex-col items-center justify-center h-full bg-slate-900"
                    v-show="isLoading" style="display: none;"> <!-- Controlled by Vue -->
                    <div
                        class="loading-spinner w-16 h-16 border-4 border-slate-700 border-t-scratch-purple rounded-full mb-4">
                    </div>
                    <p class="text-slate-400 text-lg" data-i18n="loading_editor">正在加载 Scratch 编辑器...</p>
                    <p class="text-slate-600 text-sm mt-2" data-i18n="first_load">首次加载可能需要几秒钟</p>
                </div>
                <!-- Scratch Editor Iframe -->
                <iframe id="scratch-iframe" class="w-full h-full" style="display: none;"></iframe>
            </div>
        </main>
    </div>

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                const lessons = ref([
                    { id: 1, title: '初识 Scratch：让小猫动起来', type: 'tutorial', projectId: '' }, // Empty project for clean start
                    { id: 2, title: '制作音乐动画', type: 'tutorial', projectId: '456789' }, // Example ID
                    { id: 3, title: '躲避球游戏基础', type: 'tutorial', projectId: '987654' }, // Example ID
                    { id: 4, title: '互动故事大挑战', type: 'tutorial', projectId: '123123' }  // Example ID
                ]);

                const currentLesson = ref(null);
                const isLoading = ref(true);

                // Scratch Editor URL - Using TurboWarp
                // Using 'editor' path to ensure full editor UI
                const BASE_EDITOR_URL = 'https://turbowarp.org/editor?fps=60&interpolation&hq&offscreen';

                const loadLesson = (lesson) => {
                    currentLesson.value = lesson;
                    isLoading.value = true;

                    const iframe = document.getElementById('scratch-iframe');
                    iframe.style.display = 'none';

                    // If lesson has a specific project ID, we could load it. 
                    // For now, TurboWarp loads empty by default or by ID via URL hash usually, 
                    // but embedding specific projects needs correct URL format: https://turbowarp.org/PROJECT_ID/editor

                    let url = BASE_EDITOR_URL;
                    if (lesson.projectId) {
                        // Note: TurboWarp structure might vary, but widely supports loading existing scratch projects
                        // url = `https://turbowarp.org/${lesson.projectId}/editor`;
                        // For this demo, we'll just reload the base editor to simulate "new lesson environment"
                        // In a real app, you'd integrate with the VM definition.
                        console.log("Loading project: " + lesson.projectId);
                    }

                    // Reload iframe
                    iframe.src = url;

                    // Reset loading state on load
                    iframe.onload = () => {
                        isLoading.value = false;
                        iframe.style.display = 'block';
                    };
                };

                const resetEditor = () => {
                    loadLesson({ id: 0, title: 'New Project', projectId: '' });
                    currentLesson.value = null;
                };

                // Initial Load
                onMounted(() => {
                    const iframe = document.getElementById('scratch-iframe');
                    const loadingEl = document.getElementById('loading');

                    // Handle initial static loading element visibility manually before Vue takes over fully
                    // (Vue v-show handles it after mount)

                    iframe.src = BASE_EDITOR_URL;
                    iframe.onload = () => {
                        isLoading.value = false;
                        iframe.style.display = 'block';
                    };
                });

                return {
                    lessons,
                    currentLesson,
                    loadLesson,
                    resetEditor,
                    isLoading
                };
            }
        }).mount('#app');

        // Existing Vanilla JS functions for top bar (kept for compatibility with inline onclicks)

        // Save Project
        window.saveProject = function () {
            alert('提示：\n\n1. 在编辑器内点击"文件 > 保存到电脑"即可保存项目\n2. 项目会保存为 .sb3 文件\n3. 下次可以通过"文件 > 从电脑中上传"来加载项目');
        }

        // Share Project  
        window.shareProject = function () {
            alert('分享功能提示：\n\n1. 先保存项目到电脑\n2. 访问 https://scratch.mit.edu 创建账号\n3. 上传并分享你的作品\n\n或者使用 TurboWarp 的分享功能（编辑器内）');
        }

        // Toggle Fullscreen
        window.toggleFullscreen = function () {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // Language Logic (Vanilla implementation migrated inside or kept as is)
        let currentLang = localStorage.getItem('ide_lang') || 'zh';
        const translations = {
            zh: {
                ide_title: 'Scratch IDE',
                ide_subtitle: '在线编程环境',
                save: '保存',
                share: '分享',
                loading_editor: '正在加载 Scratch 编辑器...',
                first_load: '首次加载可能需要几秒钟',
                lessons: '教学课程',
                reset_editor: '重置编辑器',
                load_failed: '编辑器加载失败'
            },
            en: {
                ide_title: 'Scratch IDE',
                ide_subtitle: 'Online Programming Environment',
                save: 'Save',
                share: 'Share',
                loading_editor: 'Loading Scratch Editor...',
                first_load: 'First load may take a few seconds',
                lessons: 'Tutorials',
                reset_editor: 'Reset Editor',
                load_failed: 'Editor failed to load'
            }
        };

        window.setLanguage = function (lang) {
            currentLang = lang;
            localStorage.setItem('ide_lang', lang);

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });

            const langText = document.getElementById('lang-text');
            if (langText) {
                langText.textContent = lang === 'zh' ? 'EN' : '中文';
            }
        }

        window.toggleLanguage = function () {
            setLanguage(currentLang === 'zh' ? 'en' : 'zh');
        }

        // Initialize language
        window.addEventListener('load', () => {
            setLanguage(currentLang);
        });

    </script>
</body>

</html>