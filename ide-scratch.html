<!DOCTYPE html>
<html lang="zh-CN" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Scratch IDE | åœ¨çº¿ç¼–ç¨‹</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        scratch: {
                            orange: '#FFAB19',
                            purple: '#855CD6',
                            cyan: '#4D97FF',
                            green: '#4CBF56'
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Outfit', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #scratch-container {
            width: 100%;
            height: calc(100vh - 64px);
        }

        #scratch-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-slate-900 text-white">
    <div id="app" class="flex h-screen bg-slate-900 text-white">
        <!-- Left Sidebar: Lessons -->
        <aside class="w-64 bg-slate-800 border-r border-slate-700 p-4 overflow-y-auto">
            <h2 class="text-lg font-bold mb-4" data-i18n="lessons">æ•™å­¦è¯¾ç¨‹</h2>
            <ul class="space-y-2">
                <li v-for="lesson in lessons" :key="lesson.id" class="cursor-pointer p-2 rounded hover:bg-slate-700"
                    @click="loadLesson(lesson)">
                    {{ lesson.title }}
                </li>
            </ul>
            <button @click="resetEditor"
                class="mt-6 w-full px-3 py-2 bg-scratch-purple hover:bg-purple-600 rounded text-center font-semibold">
                é‡ç½®ç¼–è¾‘å™¨
            </button>
        </aside>

        <!-- Main Area: Editor -->
        <main class="flex-1 flex flex-col">
            <!-- Top Bar (same as before) -->
            <nav
                class="h-16 border-b border-slate-700 bg-slate-900/95 backdrop-blur flex items-center justify-between px-6">
                <div class="flex items-center gap-4">
                    <a href="coding.html" class="p-2 rounded-lg hover:bg-slate-800 transition-colors">
                        <svg width="24" height="24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </a>
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-xl bg-gradient-to-br from-scratch-purple to-purple-600 flex items-center justify-center text-white font-black text-xl shadow-lg">
                            S</div>
                        <div>
                            <h1 class="font-bold text-white text-lg leading-tight" data-i18n="ide_title">Scratch IDE
                            </h1>
                            <div class="text-[10px] text-slate-500 uppercase tracking-widest font-bold"
                                data-i18n="ide_subtitle">åœ¨çº¿ç¼–ç¨‹ç¯å¢ƒ</div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="toggleLanguage()"
                        class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-2"><svg
                            width="16" height="16" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
                        </svg><span id="lang-text">EN</span></button>
                    <button onclick="saveProject()"
                        class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-2"><svg
                            width="16" height="16" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h8a2 2 0 002-2V9a2 2 0 00-2-2h-1M8 7V5a2 2 0 012-2h2a2 2 0 012 2v2M8 7v5" />
                        </svg><span data-i18n="save">ä¿å­˜</span></button>
                    <button onclick="shareProject()"
                        class="px-4 py-2 bg-scratch-purple hover:bg-purple-600 rounded-lg text-sm font-bold transition-colors flex items-center gap-2"><svg
                            width="16" height="16" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm-1.316 6.632a3 3 0 11-5.367-2.684 3 3 0 015.367 2.684z" />
                        </svg><span data-i18n="share">åˆ†äº«</span></button>
                    <button onclick="toggleFullscreen()" class="p-2 rounded-lg hover:bg-slate-800 transition-colors"
                        title="å…¨å±"><svg width="20" height="20" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                        </svg></button>
                </div>
            </nav>

            <div id="scratch-container" v-if="!isEditorActive"
                class="flex-1 relative bg-slate-900 flex flex-col items-center justify-center p-8 text-center">
                <!-- Launch UI -->
                <div class="max-w-md">
                    <div
                        class="w-24 h-24 bg-scratch-purple/20 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl shadow-purple-900/20 border border-scratch-purple/20">
                        <span class="text-6xl">ğŸš€</span>
                    </div>
                    <h2 class="text-3xl font-black text-white mb-4" data-i18n="launch_title">{{ currentLesson ?
                        currentLesson.title : 'å‡†å¤‡å¥½å¼€å§‹åˆ›ä½œäº†å—ï¼Ÿ' }}</h2>
                    <p class="text-slate-400 mb-8 leading-relaxed" data-i18n="launch_desc">
                        {{ currentLesson ? 'å³å°†å¯åŠ¨ç¼–è¾‘å™¨å¹¶å¼€å§‹æœ¬è¯¾ç¨‹çš„å­¦ä¹ ã€‚æ‚¨çš„è¿›åº¦ä¼šè‡ªåŠ¨è®°å½•ã€‚' : 'å…¨å±ç¼–è¾‘å™¨åŠ è½½ä¸­...' }}
                    </p>

                    <button @click="launchEditor"
                        class="inline-flex items-center gap-3 bg-gradient-to-r from-scratch-purple to-purple-600 hover:from-purple-500 hover:to-purple-500 text-white text-lg font-bold px-8 py-4 rounded-xl transition-all hover:scale-105 shadow-xl shadow-purple-900/30 group">
                        <span data-i18n="launch_btn">å¯åŠ¨ Scratch ç¼–è¾‘å™¨</span>
                        <svg class="w-6 h-6 group-hover:translate-x-1 transition-transform" fill="none"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                    </button>

                    <p class="mt-6 text-xs text-slate-600">Powered by TurboWarp</p>
                </div>
            </div>

            <!-- Active Editor Iframe -->
            <div v-else class="flex-1 w-full h-full bg-black relative">
                <div v-if="loading"
                    class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 z-10">
                    <div
                        class="w-12 h-12 border-4 border-scratch-purple border-t-white rounded-full loading-spinner mb-4">
                    </div>
                    <p class="text-white font-bold" data-i18n="loading_editor">æ­£åœ¨åŠ è½½ Scratch ç¼–è¾‘å™¨...</p>
                </div>
                <iframe :src="editorUrl" class="w-full h-full border-0" allowtransparency="true" allowfullscreen="true"
                    allow="geolocation; microphone; camera; midi" @load="loading = false"></iframe>
            </div>
        </main>
    </div>

    <!-- Shared Storage Logic -->
    <script src="assets/js/project-storage.js"></script>

    <!-- Share Modal -->
    <div id="share-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 rounded-2xl p-6 w-full max-w-md border border-slate-700 shadow-2xl">
            <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <span class="text-scratch-purple">â˜ï¸</span>
                <span data-i18n="share_project">åˆ†äº«ä½œå“</span>
            </h3>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-400 mb-1" data-i18n="project_title">é¡¹ç›®æ ‡é¢˜</label>
                    <input type="text" id="proj-title"
                        class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 focus:border-scratch-purple outline-none transition-colors"
                        placeholder="æˆ‘çš„ç²¾å½©ä½œå“">
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-400 mb-1" data-i18n="project_desc">é¡¹ç›®æè¿°</label>
                    <textarea id="proj-desc" rows="3"
                        class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 focus:border-scratch-purple outline-none transition-colors"
                        placeholder="ä»‹ç»ä¸€ä¸‹ä½ çš„ä½œå“ç©æ³•..."></textarea>
                </div>

                <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-3 text-sm text-blue-300">
                    <p class="font-bold mb-1">ğŸ’¡ æç¤º (Tip)</p>
                    <p>è¯·å…ˆåœ¨ç¼–è¾‘å™¨ä¸­ç‚¹å‡» <b>"æ–‡ä»¶ > ä¿å­˜åˆ°ç”µè„‘"</b> è·å¾— .sb3 æ–‡ä»¶ï¼Œæ‰€æœ‰æ•°æ®å°†ä¿å­˜åˆ°ä½ çš„æµè§ˆè®°å½•ä¸­ã€‚</p>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="closeShareModal()"
                        class="flex-1 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 font-bold transition-colors"
                        data-i18n="cancel">å–æ¶ˆ</button>
                    <button onclick="confirmShare()"
                        class="flex-1 py-2 rounded-lg bg-scratch-purple hover:bg-purple-600 font-bold text-white transition-colors shadow-lg shadow-purple-900/30"
                        data-i18n="publish">å‘å¸ƒåˆ°ç¤¾åŒº</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                const lessons = ref([
                    { id: 1, title: 'åˆè¯† Scratchï¼šè®©å°çŒ«åŠ¨èµ·æ¥', type: 'tutorial', projectId: '' },
                    { id: 2, title: 'åˆ¶ä½œéŸ³ä¹åŠ¨ç”»', type: 'tutorial', projectId: '' },
                    { id: 3, title: 'èº²é¿çƒæ¸¸æˆåŸºç¡€', type: 'tutorial', projectId: '' },
                    { id: 4, title: 'äº’åŠ¨æ•…äº‹å¤§æŒ‘æˆ˜', type: 'tutorial', projectId: '' }
                ]);

                const editorUrl = ref('https://turbowarp.org/editor');
                const currentLesson = ref(null);

                const loadLesson = (lesson) => {
                    currentLesson.value = lesson;
                    // In a real app, we might append ?tutorial=ID to the editor URL
                    // For now, valid visual feedback is enough
                };

                onMounted(() => {
                    // Check for project_url in query params to construct dynamic URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const projectUrl = urlParams.get('project_url');
                    const remix = urlParams.get('remix');

                    let target = 'https://turbowarp.org/editor';

                    // Simple logic: if project URL exists, we might want to suggest user to load it 
                    // But TurboWarp doesn't have a simple ?load_url= param universal for all cases without CORS.
                    // However, we can use #url logic if supported or just open editor.
                    // For now, simple open.

                    // Specific TurboWarp param for loading from URL (if supported by them):
                    // target += '#https://example.com/project.sb3'; 
                });

                const isEditorActive = ref(false);
                const loading = ref(true);

                const launchEditor = () => {
                    isEditorActive.value = true;
                    loading.value = true;
                };

                const resetEditor = () => {
                    currentLesson.value = null;
                    isEditorActive.value = false;
                };

                return { lessons, currentLesson, loadLesson, resetEditor, editorUrl, isEditorActive, launchEditor, loading };
            }
        }).mount('#app');

        // --- Share Feature Logic ---
        window.shareProject = function () {
            const modal = document.getElementById('share-modal');
            modal.classList.remove('hidden');

            // Auto-fill for Remix
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('remix') === 'true') {
                const originalTitle = urlParams.get('original_title');
                const titleInput = document.getElementById('proj-title');
                // Only fill if empty to avoid overwriting user input
                if (!titleInput.value && originalTitle) {
                    titleInput.value = `Remix of ${originalTitle}`;
                }
            }
        }

        window.closeShareModal = function () {
            document.getElementById('share-modal').classList.add('hidden');
        }

        window.confirmShare = function () {
            const title = document.getElementById('proj-title').value;
            const desc = document.getElementById('proj-desc').value;

            if (!title) {
                alert('è¯·å¡«å†™é¡¹ç›®æ ‡é¢˜');
                return;
            }

            // Save to LocalStorage via ProjectStorage
            ProjectStorage.saveProject({
                title: title,
                description: desc,
                author: 'Local User', // Placeholder
                type: 'scratch',
                isLocal: true,
                thumbnail_url: null // Could add file input to upload wrapper image later
            });

            alert('âœ… å‘å¸ƒæˆåŠŸï¼\n\nä½ çš„ä½œå“å·²æ·»åŠ åˆ°"ç¤¾åŒºå®éªŒå®¤"é¡µé¢ã€‚');
            closeShareModal();
            // Optional: Redirect to community
            // window.location.href = 'coding.html';
        }

        // --- Existing Logic ---
        window.saveProject = function () {
            alert('æç¤ºï¼š\n\n1. åœ¨ç¼–è¾‘å™¨å†…ç‚¹å‡»"æ–‡ä»¶ > ä¿å­˜åˆ°ç”µè„‘"å³å¯ä¿å­˜é¡¹ç›®\n2. é¡¹ç›®ä¼šä¿å­˜ä¸º .sb3 æ–‡ä»¶\n3. ä¸‹æ¬¡å¯ä»¥é€šè¿‡"æ–‡ä»¶ > ä»ç”µè„‘ä¸­ä¸Šä¼ "æ¥åŠ è½½é¡¹ç›®');
        }

        window.toggleFullscreen = function () {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        // Language Logic
        let currentLang = localStorage.getItem('ide_lang') || 'zh';
        const translations = {
            zh: {
                ide_title: 'Scratch IDE',
                ide_subtitle: 'åœ¨çº¿ç¼–ç¨‹ç¯å¢ƒ',
                save: 'ä¿å­˜',
                share: 'åˆ†äº«',
                loading_editor: 'æ­£åœ¨åŠ è½½ Scratch ç¼–è¾‘å™¨...',
                first_load: 'é¦–æ¬¡åŠ è½½å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ',
                lessons: 'æ•™å­¦è¯¾ç¨‹',
                reset_editor: 'é‡ç½®ç¼–è¾‘å™¨',
                share_project: 'åˆ†äº«ä½œå“',
                project_title: 'é¡¹ç›®æ ‡é¢˜',
                project_desc: 'é¡¹ç›®æè¿°',
                cancel: 'å–æ¶ˆ',
                publish: 'å‘å¸ƒåˆ°ç¤¾åŒº',
                launch_title: 'å‡†å¤‡å¥½å¼€å§‹åˆ›ä½œäº†å—ï¼Ÿ',
                launch_desc: 'ä¸ºäº†æä¾›æœ€æµç•…çš„ç¼–ç¨‹ä½“éªŒï¼Œç¼–è¾‘å™¨å°†åœ¨æ–°çª—å£ä¸­å…¨å±æ‰“å¼€ã€‚',
                launch_btn: 'å¯åŠ¨ Scratch ç¼–è¾‘å™¨'
            },
            en: {
                ide_title: 'Scratch IDE',
                ide_subtitle: 'Online Programming Environment',
                save: 'Save',
                share: 'Share',
                loading_editor: 'Loading Scratch Editor...',
                first_load: 'First load may take a few seconds',
                lessons: 'Tutorials',
                reset_editor: 'Reset Editor',
                share_project: 'Share Project',
                project_title: 'Project Title',
                project_desc: 'Project Description',
                cancel: 'Cancel',
                publish: 'Publish',
                launch_title: 'Ready to Create?',
                launch_desc: 'To provide the smoothest experience, the editor will open in a new window.',
                launch_btn: 'Launch Scratch Editor'
            }
        };

        window.setLanguage = function (lang) {
            currentLang = lang;
            localStorage.setItem('ide_lang', lang);
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) el.textContent = translations[lang][key];
            });
            const langText = document.getElementById('lang-text');
            if (langText) langText.textContent = lang === 'zh' ? 'EN' : 'ä¸­æ–‡';
        }

        window.toggleLanguage = function () {
            setLanguage(currentLang === 'zh' ? 'en' : 'zh');
        }

        window.addEventListener('load', () => setLanguage(currentLang));
    </script>
</body>

</html>